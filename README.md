# astrbot_plugin_miao

轻量级 AstrBot 插件：Miao

版本: v0.0.7

描述
----
一个轻量 AstrBot 插件，支持：

- 每日群打卡（定时）
- 批量点赞（自动对配置的 QQ 列表进行点赞）
- 抓取 B 站前瞻兑换码并附图
- 生成示例聊天节点（伪造聊天记录）
- 生成语音（调用外部 TTS 接口并返回语音文件）
- 检测包含“胡桃 + 链接”的消息并提醒管理员

主要功能与命令
----------------
以下命令均为插件内部通过 `@filter.command` 或 `@filter.regex` 暴露的指令/触发：

- 正则触发：`^赞我$`
  - 任何人发送“赞我”会触发为发送者进行点赞（会尝试最多 60 次，分批调用 API）。

- 命令：`添加点赞列表 <QQ>`
  - 仅允许插件主人（配置项 `Master`）使用。
  - 将指定 QQ 添加到 `send_like_list`，用于每日自动点赞任务。

- 正则触发：包含“胡桃”且包含“http”的消息
  - 检测到会 @ 管理员（由 `HuTao_config` 配置）并发送提醒。

- 命令：`生成语音 <头像名> <文本>`
  - 调用外部 TTS 接口生成语音并通过语音消息返回。
  - 外部 TTS API 地址示例: `http://117.72.170.58:8881/api/`（插件内直接调用）。

- 命令：`原神卡池`
  - 抓取并以聊天节点（Nodes）形式返回当前原神祈愿池（通过 `https://api.suyanw.cn/api/mihoyo_ys_pool.php`）。

- 命令：`前瞻兑换码 <游戏名>`
  - 在 B 站动态中搜索带有前瞻标签的条目，返回兑换码文本与封面图片（使用 B 站动态检索接口）。

- 命令：`伪造聊天记录 <QQ号> <昵称> <内容>`
  - 生成一条单节点聊天记录以演示伪造聊天记录的显示效果。
  - 不能对配置为 `Master` 的 QQ 伪造。

定时任务
--------
插件在初始化时注册定时任务（使用 `apscheduler` 的 `AsyncIOScheduler`）：

- `daily_tasks`（每天 00:00）：
  - `checkin_task`：对所有群执行“群打卡”操作并汇总结果，发送给管理员（`Master`）。
  - `like_task`：对配置的 `send_like_list` 执行批量点赞，并将结果发送给管理员（`Master`）。

配置项（在插件配置中）
------------------
插件使用 `self.config` 读取/保存配置：

- `Master` (int)：管理员 QQ，用于接收任务报告和受限命令（例如 `添加点赞列表`）。
- `send_like_list` (list[int])：每日自动点赞的 QQ 列表。
- `HuTao_config` (int)：当检测到“胡桃 + 链接”时要 @ 的 QQ。

示例配置（JSON）:

```
{
  "Master": 123456789,
  "send_like_list": [11111111, 22222222],
  "HuTao_config": 123456789
}
```

注意与依赖
-------------
- 依赖库（在插件环境中确保可用）：
  - `aiohttp`
  - `apscheduler`
  - `pydub`（插件导入但仅用于音频处理）
  - 其他标准库：`asyncio`, `json`, `re`, `logging` 等

- 外部 API：
  - TTS 服务：`http://117.72.170.58:8881/api/`（插件硬编码为示例地址，依赖该服务可用性）
  - 原神祈愿池：`https://api.suyanw.cn/api/mihoyo_ys_pool.php`
  - B 站动态检索接口（用于前瞻兑换码搜索）

使用与权限提醒
----------------
- 插件会尝试捕获 `aiocqhttp` 平台的内部 bot 实例以执行某些操作（点赞、群打卡等），因此仅在支持的运行时环境下可用。
- 点赞操作可能受平台限制或风控，插件中已有对常见错误的友好处理和随机回复。

开发与扩展
------------
- 若需替换或升级 TTS，请修改 `tts()` 函数中的 `api_url` 与参数处理逻辑。
- 若需改变定时策略，请修改 `schedule_jobs()` 中对 `self.scheduler.add_job` 的配置。

许可证
------
- 此文件基于插件源码自动生成。请根据你的项目选择合适的许可证。