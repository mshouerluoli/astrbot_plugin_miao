# astrbot_plugin_miao

`astrbot_plugin_miao` 是一个轻量的 AstrBot 插件（版本：v0.0.7），提供每日自动打卡、批量/单用户点赞、库街区（Kurobbs）登录与签到、前瞻兑换码抓取并附图、生成语音、以及若干消息处理工具。

## 主要功能

- 每日任务（定时）：每天 `00:00` 自动执行，包括群打卡、批量点赞与库街区签到（如果已保存用户信息）。
- 点赞功能：支持命令手动点自己（`赞我`），支持主账号批量添加点赞目标并定时点赞。
- 库街区支持：`库街区登录 手机号 验证码` 保存登录信息到本插件目录下的 `kurobbs_token.json`，并可执行 `库街区签到`。插件会使用保存的 token 在每日任务中替用户签到。
- 获取原神祈愿池：`原神卡池` 命令会抓取并以节点（Nodes）形式发送包含图标的祈愿池信息。
- 前瞻兑换码抓取：`前瞻兑换码 游戏名` 会使用 Bilibili 的动态搜索接口查找包含游戏名的前瞻，并返回兑换码与封面图（如找到）。
- 生成语音：`生成语音 说话人 文本` 使用外部 TTS API（配置在代码中）生成音频并返回（以 `Record.fromURL` 方式发送）。
- 伪造消息节点：使用 `伪造消息 QQ号 内容 | QQ号 内容 | ...` 将多个伪造消息合并为聊天节点（节点消息）。
- 检测“胡桃 + 链接”：当消息同时包含“胡桃”与 `http` 时，会 @ 配置的管理员并提醒（配置键为 `HuTao_config`）。

## 命令示例

- `赞我` — 对发送者进行点赞操作（会尽力点满每日额度）。
- `添加点赞列表 <QQ>` — 仅主人（Master）可用，将指定 QQ 添加到自动点赞列表。
- `生成语音 <说话人> <文本>` — 示例：`生成语音 派蒙 我爱旅行`。
- `原神卡池` — 获取当前可用的原神祈愿池信息并附带图标。
- `前瞻兑换码 <游戏名>` — 抓取并返回前瞻兑换码与封面。示例：`前瞻兑换码 某游戏`。
- `库街区登录 <手机号> <验证码>` — 登录并保存用户信息到 `kurobbs_token.json`。
- `库街区签到` — 使用已保存的 token 为当前用户执行签到并返回当日奖励信息。
- `伪造消息 <QQ1> <内容1> | <QQ2> <内容2> | ...` — 生成多节点伪造消息。

## 配置项（插件配置）

通过插件的 `config` 对象可设置下列字段：

- `Master` (int): 主人 QQ，用于限制某些命令的使用与接收每日任务通知。
- `send_like_list` (list[int]): 自动点赞的 QQ 列表（每日任务/手动触发时使用）。
- `HuTao_config` (int): 当检测到“胡桃 + 链接”时要 @ 的管理员 QQ。

请将这些配置写入宿主机器人所使用的插件配置位置（取决于 AstrBot 的配置实现）。

## 存储路径

保存的库街区登录信息存放于插件目录下的 `kurobbs_token.json`：

`data/plugins/astrbot_plugin_miao/kurobbs_token.json`

该文件以 JSON 格式存储，每个发送者 ID 对应一份数据。

## 外部依赖

该插件在运行时依赖下列 Python 包（请确保环境中已安装）：

- `aiohttp` — 异步 HTTP 客户端
- `apscheduler` — 定时任务调度
- `pydub` — 音频处理（若使用本地音频转换）
- `aiofiles` — 异步文件读写

此外，插件中 `tts` 使用了一个外部 TTS HTTP API（在 `main.py` 中的 `api_url` 字段）。如需替换或部署私有服务，请修改对应的 `tts` 函数。

## 注意与已知行为

- 插件会尝试在首次收到消息时捕获 `aiocqhttp` 平台的 `bot` 实例以便在定时任务中调用 API（见 `_capture_bot_instance`）。确保 bot 平台兼容或已正确注入。
- 部分第三方 API（如库街区、Bilibili 接口、TTS 服务）可能出现网络或返回格式变化，插件中已做异常处理，但仍可能出现功能不可用的情况。
- `库街区` 接口交互使用固定的请求头/字段（与原应用模拟），若接口变更请同步更新代码。

## 开发者信息

- 插件注册信息位于 `main.py` 顶部的 `@register("astrbot_plugin_miao", "miao", ..., "v0.0.7")`。
- 插件类为 `MiaoPlugin(Star)`，实现了 `initialize` 与 `terminate` 等生命周期方法。


